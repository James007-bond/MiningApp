<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MiningApp</title>
<style>
  :root{
    --bg:#0b1020; --fg:#e6eef8; --card1:#0f1724; --card2:#091023; --muted:#88b1c8; --accent:#14b8a6; --danger:#ef4444;
    font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
  }
  body{margin:0;background:var(--bg);color:var(--fg);display:flex;align-items:center;justify-content:center;min-height:100vh}
  .card{width:96%;max-width:880px;background:linear-gradient(180deg,var(--card1) 0%, var(--card2) 100%);border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(2,8,23,.6);}
  h1{margin:0 0 8px;font-size:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .panel{flex:1;min-width:260px;background:rgba(255,255,255,0.03);padding:14px;border-radius:8px}
  button{background:var(--accent);border:none;padding:10px 14px;border-radius:8px;color:#021018;font-weight:700;cursor:pointer}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .stop{background:var(--danger);color:white}
  .ghost{background:transparent;outline:1px solid rgba(255,255,255,.15);color:var(--fg)}
  .meter{height:12px;background:rgba(255,255,255,0.06);border-radius:8px;overflow:hidden;margin-top:8px}
  .meter > i{display:block;height:100%;width:4%;background:linear-gradient(90deg,#22c1c3,#1c7ed6);transition:width .2s linear}
  .stat{font-size:13px;margin-top:6px;color:#cfeffd}
  small, label{color:#9fc2d9}
  .footer{margin-top:12px;font-size:12px;color:var(--muted)}
  input{width:100%;margin-top:6px;padding:8px;border-radius:8px;border:none;background:#061225;color:#cfeffd;outline:1px solid transparent}
  input.invalid{outline-color:#ef4444}
  .hint{font-size:12px;color:#9fc2d9;margin-top:6px}
  .addr{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
</style>
<!-- TON Connect UI (CDN) -->
<script src="https://unpkg.com/@tonconnect/ui@2.3.1/dist/tonconnect-ui.min.js"></script>
</head>
<body>
  <div class="card">
    <h1>⛏️ MiningApp Panel</h1>
    <div class="row">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <div class="stat">Status: <strong id="status">Ready</strong></div>
            <small>Mining starts only when Telegram + wallet address are ready.</small>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="startBtn" disabled>Start</button>
            <button id="stopBtn" class="stop" style="display:none">Stop</button>
          </div>
        </div>

        <div style="margin-top:12px;display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:end">
          <div>
            <label for="wallet">Wallet / Withdraw Address</label>
            <input id="wallet" placeholder="Enter your address" autocomplete="off">
            <div class="hint">Address can start with any letter or number. It just must not be empty.</div>
          </div>
          <button id="linkWalletBtn" class="ghost">Link Wallet</button>
          <button id="disconnectBtn" class="ghost" style="display:none">Disconnect</button>
        </div>

        <div style="margin-top:12px">
          <div class="stat">Hashrate</div>
          <div class="meter"><i id="meterBar"></i></div>
          <div class="stat">Instant: <strong id="hr">0 H/s</strong> — Accepted: <strong id="accepted">0</strong></div>
        </div>

        <div class="footer">
          When opened as Telegram WebApp, this page uses <code>WebApp.sendData</code>. Wallet linking uses <code>TON Connect</code>.
        </div>
      </div>

      <div class="panel">
        <div class="stat"><strong>Overview</strong></div>
        <div class="stat">Uptime: <span id="runtime">00:00</span></div>
        <div class="stat">Balance: <span id="earn">0 TON</span></div>
        <!--<div class="stat">Linked address: <span id="linkedAddr" class="addr">—</span></div>-->
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="withdrawBtn">Withdraw</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* Start koşulu:
   1) Telegram WebApp içinde açılmış olacak
   2) Boş olmayan bir adres (elle veya TON Connect ile) olacak
*/

const isTelegram = !!(window.Telegram && window.Telegram.WebApp);
const tg = isTelegram ? window.Telegram.WebApp : null;

// TON Connect UI (modal)
const manifestUrl = (location.origin + location.pathname).replace(/\/$/, '') + '/tonconnect-manifest.json';
const tonUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl });

// Elements
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const meter = document.getElementById('meterBar');
const hrText = document.getElementById('hr');
const accepted = document.getElementById('accepted');
const earn = document.getElementById('earn');
const statusEl = document.getElementById('status');
const runtime = document.getElementById('runtime');
const withdrawBtn = document.getElementById('withdrawBtn');
const walletInput = document.getElementById('wallet');
const linkWalletBtn = document.getElementById('linkWalletBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const linkedAddrEl = document.getElementById('linkedAddr');

// State
let running=false, secs=0, acceptedCount=0, fakeHR=0;
let tInterval=null, runtimeInterval=null;
let linkedAddress=null;

// Helpers
function formatTime(s){ const m=Math.floor(s/60).toString().padStart(2,'0'); const ss=(s%60).toString().padStart(2,'0'); return m+':'+ss; }
function setStatus(txt){ statusEl.innerText=txt; }
function isNonEmptyAddr(a){ return /^[A-Za-z0-9].{2,}$/.test((a||'').trim()); } // ilk karakter harf/rakam ve min. 3 uzunluk
function persistWallet(){ try{ localStorage.setItem('wallet', walletInput.value.trim()); }catch{} }
function loadWallet(){ try{ const w=localStorage.getItem('wallet'); if(w) walletInput.value=w; }catch{} }
function shortAddr(a){ if(!a) return '—'; return a.length>16 ? a.slice(0,8)+'…'+a.slice(-6) : a; }
function resolveActiveAddress(){
  const inp = (walletInput.value||'').trim();
  return linkedAddress || (isNonEmptyAddr(inp) ? inp : null);
}
function updateLinkedUI(){
  linkedAddrEl.textContent = shortAddr(linkedAddress);
  disconnectBtn.style.display = linkedAddress ? 'inline-block' : 'none';
}
function enableStartIfEligible(){
  const hasAddr = !!resolveActiveAddress();
  const canStart = isTelegram && hasAddr && !running;
  startBtn.disabled = !canStart;
  walletInput.classList.toggle('invalid', !hasAddr && walletInput.value.trim().length>0);
  if(isTelegram){
    try{
      if(canStart){ tg.MainButton.enable(); tg.MainButton.setText('Start Mining'); }
      else { tg.MainButton.disable(); tg.MainButton.setText('Set Address First'); }
    }catch(_){}
  }
}

loadWallet(); enableStartIfEligible();

// Telegram theming + setup
if(isTelegram){
  try{
    tg.ready(); tg.expand();
    const th = tg.themeParams || {};
    if(th.bg_color){ document.documentElement.style.setProperty('--bg', th.bg_color); }
    if(th.text_color){ document.documentElement.style.setProperty('--fg', th.text_color); }
    tg.MainButton.show();
    tg.MainButton.onClick(()=>{ if(!startBtn.disabled) startMining(); });
  }catch(e){}
} else {
  startBtn.title = 'Open inside Telegram';
}

// TON Connect wiring
async function openTonModal(){
  try{
    await tonUI.openModal(); // Telegram Wallet dâhil cüzdan listesi
  }catch(e){
    console.warn('TON Connect modal error:', e);
  }
}
tonUI.onStatusChange((walletInfo) => {
  if(walletInfo && walletInfo.account){
    const addr = walletInfo.account.address || walletInfo.account.addresses?.[0]?.address || null;
    linkedAddress = addr || null;
    if(linkedAddress){ walletInput.value = linkedAddress; persistWallet(); }
    updateLinkedUI(); enableStartIfEligible(); setStatus('Wallet linked');
  } else {
    linkedAddress = null; updateLinkedUI(); enableStartIfEligible(); setStatus('Wallet disconnected');
  }
});

// Buttons
linkWalletBtn.addEventListener('click', openTonModal);
disconnectBtn.addEventListener('click', async ()=>{ try{ await tonUI.disconnect(); } catch(_){ } });

walletInput.addEventListener('input', ()=>{ persistWallet(); enableStartIfEligible(); });
walletInput.addEventListener('change', ()=>{ persistWallet(); enableStartIfEligible(); });

// Simulation
function startMining(){
  if(!isTelegram){ alert('Please open this Mini App inside Telegram.'); return; }
  const addr = resolveActiveAddress();
  if(!addr){ alert('Link wallet or enter an address first.'); walletInput.focus(); return; }
  if(running) return;

  running=true; secs=0; acceptedCount=0; fakeHR=0;
  startBtn.style.display='none'; stopBtn.style.display='inline-block';
  setStatus('Mining…');
  meter.style.width='4%'; hrText.innerText='0 H/s'; accepted.innerText='0'; earn.innerText='0 TON';

  tInterval=setInterval(()=>{
    fakeHR=Math.max(1,Math.floor(50+Math.random()*1400));
    const w=Math.min(100,4+fakeHR/15);
    meter.style.width=w+'%'; hrText.innerText=fakeHR+' H/s';
    if(Math.random()<0.18){
      acceptedCount++;
      accepted.innerText=acceptedCount;
      earn.innerText=(acceptedCount*0.00005).toFixed(6)+' TON';
      if(isTelegram){
        try{
          tg.sendData(JSON.stringify({
            action:'share',
            accepted:acceptedCount, hr:fakeHR,
            wallet:addr
          }));
        }catch(_){}
      }
    }
  },1000);

  runtimeInterval=setInterval(()=>{
    secs++;
    runtime.innerText=formatTime(secs);
  },1000);

  enableStartIfEligible();
}

function stopMining(){
  if(!running)return;
  running=false;
  startBtn.style.display='inline-block'; stopBtn.style.display='none';
  setStatus('Stopped');
  clearInterval(tInterval);
  clearInterval(runtimeInterval);
  enableStartIfEligible();
}

function withdraw(){
  if(!isTelegram){ alert('Open inside Telegram to withdraw.'); return; }
  const addr = resolveActiveAddress();
  if(!addr){ alert('Link wallet or enter an address first.'); walletInput.focus(); return; }

  const amount=parseFloat((earn.innerText||'0 TON').replace(' TON',''))||0;
  const payload={action:'withdraw',wallet:addr,amount,accepted:acceptedCount,hr:fakeHR,ts:Date.now()};
  try{ tg.sendData(JSON.stringify(payload)); setStatus('Withdraw sent to bot'); }
  catch(e){ alert('sendData error: '+e.message); }
}

// Events
startBtn.addEventListener('click',startMining);
stopBtn.addEventListener('click',stopMining);
withdrawBtn.addEventListener('click',withdraw);

// Initial
updateLinkedUI();
</script>
</body>
</html>
