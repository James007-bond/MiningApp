<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MiningApp</title>
<style>
  :root{
    --bg:#0b1020; --fg:#e6eef8; --card1:#0f1724; --card2:#091023; --muted:#88b1c8; --accent:#14b8a6; --danger:#ef4444;
    font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
  }
  body{margin:0;background:var(--bg);color:var(--fg);display:flex;align-items:center;justify-content:center;min-height:100vh}
  .card{width:96%;max-width:820px;background:linear-gradient(180deg,var(--card1) 0%, var(--card2) 100%);border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(2,8,23,.6);}
  h1{margin:0 0 8px;font-size:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .panel{flex:1;min-width:220px;background:rgba(255,255,255,0.03);padding:14px;border-radius:8px}
  button{background:var(--accent);border:none;padding:10px 14px;border-radius:8px;color:#021018;font-weight:700;cursor:pointer}
  button[disabled]{opacity:.6;cursor:not-allowed}
  button.stop{background:var(--danger);color:white}
  .meter{height:12px;background:rgba(255,255,255,0.06);border-radius:8px;overflow:hidden;margin-top:8px}
  .meter > i{display:block;height:100%;width:4%;background:linear-gradient(90deg,#22c1c3,#1c7ed6);transition:width .2s linear}
  .stat{font-size:13px;margin-top:6px;color:#cfeffd}
  small, label{color:#9fc2d9}
  .footer{margin-top:12px;font-size:12px;color:var(--muted)}
  input{width:100%;margin-top:6px;padding:8px;border-radius:8px;border:none;background:#061225;color:#cfeffd}
</style>
</head>
<body>
  <div class="card">
    <h1>⛏️ MiningApp Panel</h1>
    <div class="row">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <div class="stat">Status: <strong id="status">Ready</strong></div>
            <small>Welcome to our mining system (demo stats).</small>
          </div>
          <div>
            <button id="startBtn">Start</button>
            <button id="stopBtn" class="stop" style="display:none">Stop</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <label for="wallet">Withdraw TON Address</label>
          <input id="wallet" placeholder="EQC..." autocomplete="off">
        </div>

        <div style="margin-top:12px">
          <div class="stat">Hashrate</div>
          <div class="meter"><i id="meterBar"></i></div>
          <div class="stat">Instant: <strong id="hr">0 H/s</strong> — Accepted: <strong id="accepted">0</strong></div>
        </div>

        <div class="footer">
          When opened as Telegram WebApp, this page can send data to your bot via <code>WebApp.sendData</code>.
        </div>
      </div>

      <div class="panel" style="min-width:200px">
        <div class="stat"><strong>Overview</strong></div>
        <div class="stat">Uptime: <span id="runtime">00:00</span></div>
        <div class="stat">Demo balance: <span id="earn">0 TON</span></div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="sendBot">Withdraw</button>
          <button id="reportBtn">Send Report</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* Demo miner — does not perform real mining.
   Uses Telegram WebApp API if available (sendData, MainButton, theme params). */

const isTelegram = !!(window.Telegram && window.Telegram.WebApp);
const tg = isTelegram ? window.Telegram.WebApp : null;

// Elements
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const meter = document.getElementById('meterBar');
const hrText = document.getElementById('hr');
const accepted = document.getElementById('accepted');
const earn = document.getElementById('earn');
const statusEl = document.getElementById('status');
const runtime = document.getElementById('runtime');
const sendBot = document.getElementById('sendBot');
const reportBtn = document.getElementById('reportBtn');
const walletInput = document.getElementById('wallet');

// State
let running=false, secs=0, acceptedCount=0, fakeHR=0;
let tInterval=null, runtimeInterval=null;

// Helpers
function formatTime(s){
  const m = Math.floor(s/60).toString().padStart(2,'0');
  const ss = (s%60).toString().padStart(2,'0');
  return m+':'+ss;
}
function setStatus(txt){ statusEl.innerText = txt; }
function setButtons(startVisible){
  startBtn.style.display = startVisible ? 'inline-block' : 'none';
  stopBtn.style.display  = startVisible ? 'none' : 'inline-block';
}
function isTonAddr(a){ return /^E[Q|f][A-Za-z0-9_-]{10,}$/.test((a||'').trim()); } // basic TON pattern (lenient)
function persistWallet(){ try{ localStorage.setItem('wallet', walletInput.value.trim()); }catch{} }
function loadWallet(){ try{ const w=localStorage.getItem('wallet'); if(w) walletInput.value=w; }catch{} }
loadWallet();

// Telegram theming (optional)
if(isTelegram){
  try{
    tg.ready();
    tg.expand();
    const th = tg.themeParams || {};
    if(th.bg_color){ document.documentElement.style.setProperty('--bg', th.bg_color); }
    if(th.text_color){ document.documentElement.style.setProperty('--fg', th.text_color); }
    if(th.hint_color){ document.documentElement.style.setProperty('--muted', th.hint_color); }
    // MainButton example
    tg.MainButton.setText('Start Mining');
    tg.MainButton.show();
    tg.MainButton.onClick(()=>{ if(!running) startMining(); });
  }catch(e){}
}

// Mining simulation
function startMining(){
  if(running) return;
  running=true;
  secs=0; acceptedCount=0; fakeHR=0;
  setButtons(false);
  setStatus('Mining…');
  meter.style.width='4%';
  hrText.innerText='0 H/s';
  accepted.innerText='0';
  earn.innerText='0 TON';
  startBtn.disabled = true; // prevent double clicks briefly

  tInterval = setInterval(()=>{
    fakeHR = Math.max(1, Math.floor(50 + Math.random()*1400));
    const w = Math.min(100, 4 + fakeHR/15);
    meter.style.width = w + '%';
    hrText.innerText = fakeHR + ' H/s';

    if(Math.random() < 0.18){
      acceptedCount += 1;
      accepted.innerText = String(acceptedCount);
      const amount = (acceptedCount * 0.00005).toFixed(6);
      earn.innerText = amount + ' TON';
      if(isTelegram){
        try {
          tg.sendData(JSON.stringify({action:'share', accepted:acceptedCount, hr:fakeHR, wallet:walletInput.value||null}));
        } catch(_) {}
      }
    }
  }, 1000);

  runtimeInterval = setInterval(()=>{
    secs++;
    runtime.innerText = formatTime(secs);
  }, 1000);

  setTimeout(()=>{ startBtn.disabled=false; }, 400);
}

function stopMining(){
  if(!running) return;
  running=false;
  setButtons(true);
  setStatus('Stopped');
  clearInterval(tInterval);
  clearInterval(runtimeInterval);
}

function sendReport(){
  const payload = { action:'report', running, uptime_sec:secs, accepted:acceptedCount, hr:fakeHR, wallet:(walletInput.value||null), ts:Date.now() };
  if(isTelegram){
    try{ tg.sendData(JSON.stringify(payload)); setStatus('Report sent to bot'); }
    catch(e){ alert('sendData error: ' + e.message); }
  } else {
    alert('Demo mode — would send:\n' + JSON.stringify(payload,null,2));
  }
}

function requestWithdraw(){
  const addr = (walletInput.value||'').trim();
  if(!addr){ alert('Please enter your TON address.'); walletInput.focus(); return; }
  if(!isTonAddr(addr)){ alert('TON address looks invalid. It should start like EQC…'); walletInput.focus(); return; }
  persistWallet();

  // You can add an "amount" input later; here we use demo balance:
  const balanceStr = (earn.innerText||'0 TON').replace(' TON','');
  const amount = Number(balanceStr)||0;

  const payload = { action:'withdraw', wallet: addr, amount, running, accepted:acceptedCount, hr:fakeHR, ts:Date.now() };
  if(isTelegram){
    try{ tg.sendData(JSON.stringify(payload)); setStatus('Withdraw request sent'); }
    catch(e){ alert('sendData error: ' + e.message); }
  } else {
    alert('Demo mode — would withdraw:\n' + JSON.stringify(payload,null,2));
  }
}

// Bindings
startBtn.addEventListener('click', startMining);
stopBtn.addEventListener('click', stopMining);
reportBtn.addEventListener('click', sendReport);
sendBot.addEventListener('click', requestWithdraw);
walletInput.addEventListener('change', persistWallet);
</script>
</body>
</html>
