<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MiningApp</title>
<style>
  :root{
    --bg:#0b1020; --fg:#e6eef8; --card1:#0f1724; --card2:#091023; --muted:#88b1c8; --accent:#14b8a6; --danger:#ef4444;
    font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
  }
  body{margin:0;background:var(--bg);color:var(--fg);display:flex;align-items:center;justify-content:center;min-height:100vh}
  .card{width:96%;max-width:880px;background:linear-gradient(180deg,var(--card1) 0%, var(--card2) 100%);border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(2,8,23,.6);}
  h1{margin:0 0 8px;font-size:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .panel{flex:1;min-width:260px;background:rgba(255,255,255,0.03);padding:14px;border-radius:8px}
  button{background:var(--accent);border:none;padding:10px 14px;border-radius:8px;color:#021018;font-weight:700;cursor:pointer}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .stop{background:var(--danger);color:white}
  .ghost{background:transparent;outline:1px solid rgba(255,255,255,.15);color:var(--fg)}
  .meter{height:12px;background:rgba(255,255,255,0.06);border-radius:8px;overflow:hidden;margin-top:8px}
  .meter > i{display:block;height:100%;width:4%;background:linear-gradient(90deg,#22c1c3,#1c7ed6);transition:width .2s linear}
  .stat{font-size:13px;margin-top:6px;color:#cfeffd}
  small, label{color:#9fc2d9}
  .footer{margin-top:12px;font-size:12px;color:var(--muted)}
  input{width:100%;margin-top:6px;padding:8px;border-radius:8px;border:none;background:#061225;color:#cfeffd}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;margin-left:8px;background:#0b3b2f;color:#9ff2d9;border:1px solid #14b8a6;}
  .addr{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
</style>
<!-- TON Connect UI (CDN) -->
<script src="https://unpkg.com/@tonconnect/ui@2.3.1/dist/tonconnect-ui.min.js"></script>
</head>
<body>
  <div class="card">
    <h1>⛏️ MiningApp Panel</h1>
    <div class="row">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <div class="stat">Status: <strong id="status">Ready</strong><span id="lockBadge" class="badge" style="display:none">Wallet locked</span></div>
            <small>Start works on all Telegram clients after wallet is linked & approved (locked).</small>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="startBtn" disabled>Start</button>
            <button id="stopBtn" class="stop" style="display:none">Stop</button>
          </div>
        </div>

        <div style="margin-top:12px;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:end">
          <div>
            <label for="wallet">Locked Wallet Address</label>
            <input id="wallet" placeholder="Link your TON wallet first" autocomplete="off" readonly>
            <div id="walletHint" class="stat" style="margin-top:6px">Waiting for approval…</div>
          </div>
          <div style="display:flex;gap:8px">
            <button id="linkWalletBtn" class="ghost">Link Wallet</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="stat">Hashrate</div>
          <div class="meter"><i id="meterBar"></i></div>
          <div class="stat">Instant: <strong id="hr">0 H/s</strong> — Accepted: <strong id="accepted">0</strong></div>
        </div>

        <div class="footer">
          Uses <code>Telegram WebApp</code> (all platforms). Wallet linking via <code>TON Connect</code>.
        </div>
      </div>

      <div class="panel">
        <div class="stat"><strong>Overview</strong></div>
        <div class="stat">Uptime: <span id="runtime">00:00</span></div>
        <div class="stat">Demo balance: <span id="earn">0 TON</span></div>
        <div class="stat">Active wallet: <span id="linkedAddr" class="addr">—</span></div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="withdrawBtn">Withdraw</button>
        </div>
      </div>
    </div>
  </div>

<!-- IMPORTANT: use type="module" so top-level await works without breaking the page -->
<script type="module">
/* GOALS
   - Start works on ALL Telegram clients (iOS/Android/Desktop/Web).
   - Start only after first TON Connect approval (wallet locked).
   - Optional backend sync keeps lock across devices.

   TODOs for production:
   1) Set BACKEND_URL to your bot API.
   2) Host a valid tonconnect-manifest.json at the same origin/path (HTTPS), or change manifestUrl accordingly.
   3) Enforce the lock on your backend using Telegram WebApp initData verification (HMAC SHA-256).
*/

// -------------- CONFIG (optional backend) --------------
const BACKEND_URL = ""; // REQUIRED for durable lock across sessions; server must delete mapping when user deletes the bot/chat // e.g. "https://your-bot-api.example.com/webapp/lock"

// -------------- Telegram & TON Connect -----------------
const isTelegram = !!(window.Telegram && window.Telegram.WebApp);
const tg = isTelegram ? window.Telegram.WebApp : null;

const manifestUrl = (location.origin + location.pathname).replace(/\/$/, '') + '/tonconnect-manifest.json';
const tonUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl });
// try to restore previous TON connection if wallet allows it
if (tonUI.restoreConnection) {
  try { tonUI.restoreConnection(); } catch(_) {}
}

// -------------- Elements -------------------------------
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const meter = document.getElementById('meterBar');
const hrText = document.getElementById('hr');
const accepted = document.getElementById('accepted');
const earn = document.getElementById('earn');
const statusEl = document.getElementById('status');
const runtime = document.getElementById('runtime');
const withdrawBtn = document.getElementById('withdrawBtn');
const walletInput = document.getElementById('wallet'); walletInput.setAttribute('aria-readonly','true'); walletInput.setAttribute('tabindex','-1');
const linkWalletBtn = document.getElementById('linkWalletBtn');
const linkedAddrEl = document.getElementById('linkedAddr');
const lockBadge = document.getElementById('lockBadge');
const walletHint = document.getElementById('walletHint');

// -------------- State ----------------------------------
let running=false, secs=0, acceptedCount=0, fakeHR=0;
let tInterval=null, runtimeInterval=null;

let walletLocked = false;
let lockedAddress = null;

// -------------- Persist (session cache only) ------------------------
// Requirement: Wallet address can only be set via TON Connect (Link Wallet).
// It should remain associated until the Mini App (bot) is deleted. That durable
// persistence must be enforced on the BACKEND keyed to Telegram initData.
// On the client we only keep a session cache so the user cannot "manually" set it
// and it won't linger if the page is reloaded without backend confirmation.
function cacheLockSession(addr){
  try{ sessionStorage.setItem('lockedAddress', addr || ''); }catch{}
}
function readLockSession(){
  try{ const a = sessionStorage.getItem('lockedAddress') || null; return a; }catch{ return null; }
}

// -------------- UI Helpers ----------------------------- -----------------------------
function formatTime(s){ const m=Math.floor(s/60).toString().padStart(2,'0'); const ss=(s%60).toString().padStart(2,'0'); return m+':'+ss; }
function setStatus(txt){ statusEl.innerText=txt; }
function shortAddr(a){ if(!a) return '—'; return a.length>16 ? a.slice(0,8)+'…'+a.slice(-6) : a; }
function resolveActiveAddress(){ return lockedAddress || null; }

function applyLockUI(){
  const hasLock = walletLocked && !!lockedAddress;
  lockBadge.style.display = hasLock ? 'inline-block' : 'none';
  walletInput.value = hasLock ? lockedAddress : '';
  walletInput.readOnly = true; // no manual edit allowed
  linkWalletBtn.style.display = hasLock ? 'none' : 'inline-block';
  linkedAddrEl.textContent = shortAddr(lockedAddress);
  walletHint.textContent = hasLock ? 'Wallet is locked for this bot.' : 'Waiting for approval…';
}

function enableStartIfEligible(){
  const hasAddr = !!resolveActiveAddress();
  const canStart = isTelegram && hasAddr && !running;
  startBtn.disabled = !canStart;
  if(isTelegram){
    try{
      tg.MainButton.show();
      if(canStart){ tg.MainButton.enable(); tg.MainButton.setText('Start Mining'); }
      else { tg.MainButton.disable(); tg.MainButton.setText(hasAddr?'Open in Telegram':'Link Wallet First'); }
    }catch(_){/* ignore */}
  }
}

// -------------- Telegram setup -------------------------
if(isTelegram){
  try{
    tg.ready();
    tg.expand();
    const th = tg.themeParams || {};
    if(th.bg_color){ document.documentElement.style.setProperty('--bg', th.bg_color); }
    if(th.text_color){ document.documentElement.style.setProperty('--fg', th.text_color); }
    tg.MainButton.onClick(()=>{ if(!startBtn.disabled) startMining(); });
  }catch(e){/* ignore */}
} else {
  // If opened outside Telegram, hint to open inside TG
  startBtn.title = 'Open inside Telegram';
}

// -------------- Optional backend sync ------------------
async function syncLockFromBackend(){
  if(!isTelegram || !BACKEND_URL) return;
  try{
    const initData = tg.initData || "";
    const res = await fetch(BACKEND_URL + "/status", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ initData })
    });
    if(!res.ok) return;
    const data = await res.json(); // { locked:boolean, address:string|null }
    if(data && data.locked && data.address){
      walletLocked = true;
      lockedAddress = data.address;
      cacheLockSession(lockedAddress); // session-only hint; server is source of truth
    } else {
      walletLocked = false;
      lockedAddress = null;
      cacheLockSession('');
    }
  }catch(e){ /* silent */ }
}

// -------------- First load -----------------------------
// Diagnostic banner to see why Start is disabled
(function diagnostic(){
  const bar=document.createElement('div');
  bar.style.cssText='position:fixed;left:12px;bottom:12px;font:12px/1.4 system-ui;color:#9fc2d9;background:#091023;padding:8px 10px;border:1px solid #1e2a44;border-radius:8px;opacity:.9;z-index:9';
  bar.id='diagBar';
  document.body.appendChild(bar);
  function render(){
    bar.innerHTML =
      'TG:'+ (isTelegram?'✅':'❌') +
      ' • Wallet:'+ (walletLocked?'✅':'❌') +
      ' • Addr:'+ (lockedAddress?shortAddr(lockedAddress):'—');
  }
  setInterval(render,500);
})();

applyLockUI();
enableStartIfEligible();

// -------------- TON Connect flow -----------------------
async function openTonModal(){
  if(walletLocked){ return; }
  try{
    await tonUI.openModal();
  }catch(e){
    console.warn('TON Connect modal error:', e);
    alert('TON Connect error: '+ (e && e.message ? e.message : e));
  }
}
  try{
    await tonUI.openModal(); // Supports Telegram Wallet
  }catch(e){
    console.warn('TON Connect modal error:', e);
  }
}

// react to wallet status changes
// NOTE: ensure the connected account is read and locked only once
let tonStatusHandled = false;
// If already connected (restored), lock immediately
try {
  const w = tonUI?.getConnectedWallet?.();
  if(w && w.account){
    const addr = w.account.address || w.account.addresses?.[0]?.address || null;
    if(addr){
      walletLocked=true; lockedAddress=addr; cacheLockSession(lockedAddress);
    }
  }
} catch(_) {}
// react to wallet status changes (one-time lock)
let tonStatusHandled = false;
tonUI.onStatusChange(async (walletInfo) => {
  if(walletLocked) return;
  if(!walletInfo || tonStatusHandled) return;
  if(walletInfo.account){
    const addr = walletInfo.account.address || walletInfo.account.addresses?.[0]?.address || null;
    if(addr){
      tonStatusHandled = true;
      walletLocked = true;
      lockedAddress = addr;
      cacheLockSession(lockedAddress);
      applyLockUI(); enableStartIfEligible(); setStatus('Wallet linked & locked');

      if(isTelegram && BACKEND_URL){
        try{
          const initData = tg.initData || "";
          await fetch(BACKEND_URL + "/lock", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ initData, address: lockedAddress })
          });
        }catch(e){/* ignore */}
      }
    }
  }
});
      applyLockUI(); enableStartIfEligible(); setStatus('Wallet linked & locked');

      // 2) (optional) persist lock on server
      if(isTelegram && BACKEND_URL){
        try{
          const initData = tg.initData || "";
          await fetch(BACKEND_URL + "/lock", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ initData, address: lockedAddress })
          });
        }catch(e){/* ignore */}
      }
    }
  }
});

// -------------- Buttons --------------------------------
linkWalletBtn.addEventListener('click', openTonModal);

function startMining(){
  if(!isTelegram){ alert('Please open this Mini App inside Telegram.'); return; }
  if(!walletLocked || !lockedAddress){ alert('Link & approve a TON wallet first.'); return; }
  if(running) return;

  running=true; secs=0; acceptedCount=0; fakeHR=0;
  startBtn.style.display='none'; stopBtn.style.display='inline-block';
  setStatus('Mining…');
  meter.style.width='4%'; hrText.innerText='0 H/s'; accepted.innerText='0'; earn.innerText='0 TON';

  tInterval=setInterval(()=>{
    fakeHR=Math.max(1,Math.floor(50+Math.random()*1400));
    const w=Math.min(100,4+fakeHR/15);
    meter.style.width=w+'%'; hrText.innerText=fakeHR+' H/s';
    if(Math.random()<0.18){
      acceptedCount++;
      accepted.innerText=acceptedCount;
      earn.innerText=(acceptedCount*0.00005).toFixed(6)+' TON';
      if(isTelegram){
        try{
          tg.sendData(JSON.stringify({
            action:'share',
            wallet: lockedAddress,
            accepted: acceptedCount,
            hr: fakeHR
          }));
        }catch(_){/* ignore */}
      }
    }
  },1000);

  runtimeInterval=setInterval(()=>{
    secs++;
    runtime.innerText=formatTime(secs);
  },1000);

  enableStartIfEligible();
}

function stopMining(){
  if(!running)return;
  running=false;
  startBtn.style.display='inline-block'; stopBtn.style.display='none';
  setStatus('Stopped');
  clearInterval(tInterval);
  clearInterval(runtimeInterval);
  enableStartIfEligible();
}

function withdraw(){
  if(!isTelegram){ alert('Open inside Telegram to withdraw.'); return; }
  if(!walletLocked || !lockedAddress){ alert('No locked wallet. Link & approve first.'); return; }

  const amount=parseFloat((earn.innerText||'0 TON').replace(' TON',''))||0;
  const payload={action:'withdraw',wallet:lockedAddress,amount,accepted:acceptedCount,hr:fakeHR,ts:Date.now()};
  try{ tg.sendData(JSON.stringify(payload)); setStatus('Withdraw sent to bot'); }
  catch(e){ alert('sendData error: '+e.message); }
}

startBtn.addEventListener('click',startMining);
stopBtn.addEventListener('click',stopMining);
withdrawBtn.addEventListener('click',withdraw);

</script>
</body>
</html>
