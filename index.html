<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MiningApp</title>
<style>
  :root{
    --bg:#0b1020; --fg:#e6eef8; --card1:#0f1724; --card2:#091023; --muted:#88b1c8; --accent:#14b8a6; --danger:#ef4444;
    font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
  }
  body{margin:0;background:var(--bg);color:var(--fg);display:flex;align-items:center;justify-content:center;min-height:100vh}
  .card{width:96%;max-width:880px;background:linear-gradient(180deg,var(--card1) 0%, var(--card2) 100%);border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(2,8,23,.6);}
  h1{margin:0 0 8px;font-size:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .panel{flex:1;min-width:260px;background:rgba(255,255,255,0.03);padding:14px;border-radius:8px}
  button{background:var(--accent);border:none;padding:10px 14px;border-radius:8px;color:#021018;font-weight:700;cursor:pointer}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .stop{background:var(--danger);color:white}
  .ghost{background:transparent;outline:1px solid rgba(255,255,255,.15);color:var(--fg)}
  .meter{height:12px;background:rgba(255,255,255,0.06);border-radius:8px;overflow:hidden;margin-top:8px}
  .meter > i{display:block;height:100%;width:4%;background:linear-gradient(90deg,#22c1c3,#1c7ed6);transition:width .2s linear}
  .stat{font-size:13px;margin-top:6px;color:#cfeffd}
  small, label{color:#9fc2d9}
  .footer{margin-top:12px;font-size:12px;color:var(--muted)}
  input{width:100%;margin-top:6px;padding:8px;border-radius:8px;border:none;background:#061225;color:#cfeffd}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;margin-left:8px;background:#0b3b2f;color:#9ff2d9;border:1px solid #14b8a6;}
  .addr{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  #linkWalletBtn{ position:relative; z-index:2; pointer-events:auto; }
</style>
<!-- TON Connect UI (CDN) -->
<script src="https://unpkg.com/@tonconnect/ui@2.3.1/dist/tonconnect-ui.min.js"></script>
</head>
<body>
  <div class="card">
    <h1>⛏️ MiningApp Panel</h1>
    <div class="row">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <div class="stat">Status: <strong id="status">Ready</strong><span id="lockBadge" class="badge" style="display:none">Wallet locked</span></div>
            <small>Start works on all Telegram clients after wallet is linked & approved (locked).</small>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="startBtn" disabled>Start</button>
            <button id="stopBtn" class="stop" style="display:none">Stop</button>
          </div>
        </div>

        <div style="margin-top:12px;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:end">
          <div>
            <label for="wallet">Locked Wallet Address</label>
            <input id="wallet" placeholder="Link your TON wallet first" autocomplete="off" readonly>
            <div id="walletHint" class="stat" style="margin-top:6px">Waiting for approval…</div>
          </div>
          <div style="display:flex;gap:8px">
            <button id="linkWalletBtn" class="ghost" title="Link your TON wallet">Link Wallet</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="stat">Hashrate</div>
          <div class="meter"><i id="meterBar"></i></div>
          <div class="stat">Instant: <strong id="hr">0 H/s</strong> — Accepted: <strong id="accepted">0</strong></div>
        </div>

        <div class="footer">
          Uses <code>Telegram WebApp</code> (all platforms). Wallet linking via <code>TON Connect</code>.
        </div>
      </div>

      <div class="panel">
        <div class="stat"><strong>Overview</strong></div>
        <div class="stat">Uptime: <span id="runtime">00:00</span></div>
        <div class="stat">Demo balance: <span id="earn">0 TON</span></div>
        <div class="stat">Active wallet: <span id="linkedAddr" class="addr">—</span></div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="withdrawBtn">Withdraw</button>
        </div>
      </div>
    </div>
  </div>

<!-- Tek dosya: module script -->
<script type="module">
/* === Tek dosyalık Mini App mantığı ===
   - Wallet sadece TON Connect ile bağlanır (elle giriş yok).
   - Wallet yoksa Start hiçbir zaman aktif olmaz.
   - Kilit varsa Link Wallet gizlenir.
*/

// ----------------- TON & Telegram -----------------
const isTelegram = !!(window.Telegram && window.Telegram.WebApp);
const tg = isTelegram ? window.Telegram.WebApp : null;
const manifestUrl = (location.origin + location.pathname).replace(/\/$/, '') + '/tonconnect-manifest.json';
const tonUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl });
if (tonUI.restoreConnection) { try { tonUI.restoreConnection(); } catch(_) {} }

// ----------------- Elements -----------------
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const meter = document.getElementById('meterBar');
const hrText = document.getElementById('hr');
const accepted = document.getElementById('accepted');
const earn = document.getElementById('earn');
const statusEl = document.getElementById('status');
const runtime = document.getElementById('runtime');
const withdrawBtn = document.getElementById('withdrawBtn');
const walletInput = document.getElementById('wallet'); walletInput.setAttribute('aria-readonly','true'); walletInput.setAttribute('tabindex','-1');
const linkWalletBtn = document.getElementById('linkWalletBtn');
const linkedAddrEl = document.getElementById('linkedAddr');
const lockBadge = document.getElementById('lockBadge');
const walletHint = document.getElementById('walletHint');

// ----------------- State -----------------
let running=false, secs=0, acceptedCount=0, fakeHR=0;
let tInterval=null, runtimeInterval=null;
let walletLocked = false;
let lockedAddress = null;

// ----------------- Helpers -----------------
const formatTime = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
const setStatus = t => statusEl.textContent = t;
const shortAddr = a => !a ? '—' : (a.length>16 ? a.slice(0,8)+'…'+a.slice(-6) : a);

// Adres normalize edici: obje/ham JSON/string her durumdan temiz string döner
function normalizeTonAddr(a) {
  if (a == null) return "";
  if (typeof a === "string" && a.includes("{") && a.includes("address")) {
    try { a = JSON.parse(a); } catch(_) {}
  }
  if (typeof a === "object") {
    if (typeof a.address === "string") a = a.address;
    else if (Array.isArray(a.addresses) && typeof a.addresses[0]?.address === "string") a = a.addresses[0].address;
    else if (typeof a.toString === "function") a = a.toString();
    else return "";
  }
  if (typeof a !== "string") return "";
  a = a.trim().replace(/\s+/g, "").toUpperCase();
  return a;
}

function applyLockUI(){
  const hasLock = walletLocked && !!lockedAddress;

  walletInput.value = hasLock ? normalizeTonAddr(lockedAddress) : "";
  walletInput.readOnly = true;

  if (hasLock) {
    linkWalletBtn.style.display = 'none';
  } else {
    linkWalletBtn.style.display = 'inline-block';
    linkWalletBtn.disabled = false;
    linkWalletBtn.style.pointerEvents = 'auto';
    linkWalletBtn.style.opacity = '1';
  }

  lockBadge.style.display = hasLock ? 'inline-block' : 'none';
  linkedAddrEl.textContent = shortAddr(normalizeTonAddr(lockedAddress));
  walletHint.textContent = hasLock ? 'Wallet is locked for this bot.' : 'Waiting for approval…';

  enableStartIfEligible();

  if (isTelegram) {
    try {
      tg.MainButton.show();
      if (hasLock) {
        tg.MainButton.enable();
        tg.MainButton.setText('Start Mining');
        tg.MainButton.onClick(()=>{ if(!startBtn.disabled) startMining(); });
      } else {
        tg.MainButton.enable();
        tg.MainButton.setText('Link Wallet');
        tg.MainButton.onClick(()=>{ openTonModal(); });
      }
    } catch(_) {}
  }
}

function enableStartIfEligible(){
  const canStart = isTelegram && walletLocked && !!lockedAddress && !running;
  startBtn.disabled = !canStart;
}

// ----------------- Telegram setup -----------------
if (isTelegram) {
  try {
    tg.ready();
    tg.expand();
    const th = tg.themeParams || {};
    if(th.bg_color){ document.documentElement.style.setProperty('--bg', th.bg_color); }
    if(th.text_color){ document.documentElement.style.setProperty('--fg', th.text_color); }
  } catch(_) {}
} else {
  startBtn.title = 'Open inside Telegram';
}

// ----------------- TON Connect flow -----------------
async function openTonModal(){
  if (walletLocked) return;
  try {
    await tonUI.openModal(); // Telegram Wallet dâhil
  } catch(e){
    console.warn('TON Connect modal error:', e);
    alert('TON Connect error: ' + (e?.message || e));
  }
}
linkWalletBtn.addEventListener('click', (e)=>{
  e.preventDefault(); e.stopPropagation();
  openTonModal();
});

// Restore ile gelmişse hemen kilitle
try {
  const w = tonUI?.getConnectedWallet?.();
  const addr = normalizeTonAddr(w?.account?.address ?? w?.account?.addresses?.[0]?.address ?? null);
  if (addr) { lockedAddress = addr; walletLocked = true; }
} catch(_) {}

let tonStatusHandled = false;
tonUI.onStatusChange((walletInfo)=>{
  if (walletLocked || tonStatusHandled) return;
  const addr = normalizeTonAddr(walletInfo?.account?.address ?? walletInfo?.account?.addresses?.[0]?.address ?? null);
  if (addr) {
    tonStatusHandled = true;
    lockedAddress = addr;
    walletLocked = true;
    setStatus('Wallet linked & locked');
    applyLockUI();
  }
});

// ----------------- Mining (demo) -----------------
function startMining(){
  if (!isTelegram){ alert('Please open this Mini App inside Telegram.'); return; }
  if (!walletLocked || !lockedAddress){ alert('Link & approve a TON wallet first.'); return; }
  if (running) return;

  running=true; secs=0; acceptedCount=0; fakeHR=0;
  startBtn.style.display='none'; stopBtn.style.display='inline-block';
  setStatus('Mining…');
  meter.style.width='4%'; hrText.textContent='0 H/s'; accepted.textContent='0'; earn.textContent='0 TON';

  tInterval=setInterval(()=>{
    fakeHR=Math.max(1,Math.floor(50+Math.random()*1400));
    const w=Math.min(100,4+fakeHR/15);
    meter.style.width=w+'%'; hrText.textContent=fakeHR+' H/s';
    if(Math.random()<0.18){
      acceptedCount++;
      accepted.textContent=acceptedCount;
      earn.textContent=(acceptedCount*0.00005).toFixed(6)+' TON';
    }
  },1000);

  runtimeInterval=setInterval(()=>{
    secs++;
    runtime.textContent=formatTime(secs);
  },1000);

  enableStartIfEligible();
}

function stopMining(){
  if (!running) return;
  running=false;
  startBtn.style.display='inline-block'; stopBtn.style.display='none';
  setStatus('Stopped');
  clearInterval(tInterval);
  clearInterval(runtimeInterval);
  enableStartIfEligible();
}

function withdraw(){
  if (!isTelegram){ alert('Open inside Telegram to withdraw.'); return; }
  if (!walletLocked || !lockedAddress){ alert('No locked wallet. Link & approve first.'); return; }
  alert('Withdraw request (demo): '+earn.textContent+' → '+shortAddr(lockedAddress));
}

startBtn.addEventListener('click', startMining);
stopBtn.addEventListener('click', stopMining);
withdrawBtn.addEventListener('click', withdraw);

// ----------------- İlk UI çizimi -----------------
applyLockUI();
</script>
</body>
</html>
